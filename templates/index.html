<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像処理 Webアプリ</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='style.css')}}">
</head>
<body>
    <h1>画像処理 Webアプリ</h1>
    
    <div class="container">
        <!-- 左パネル：フォーム部分 -->
        <div class="left-panel">
            <form id="image-form" enctype="multipart/form-data">
                <div class="file-upload-wrapper">
                    <input type="file" name="file" id="file-input" accept="image/*" required>
                    <label for="file-input" class="file-upload-label">
                        📁 画像を選択
                    </label>
                    <span class="file-name" id="file-name"></span>
                </div>

                <h3>処理モード選択</h3>
                <div class="checkbox-wrapper">
                    <input type="checkbox" name="mode_mosaic" id="mode-mosaic" onclick="toggleParams()">
                    <label for="mode-mosaic" class="checkbox-label">モザイクアート</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" name="mode_popart" id="mode-popart" onclick="toggleParams()">
                    <label for="mode-popart" class="checkbox-label">ポップアート</label>
                </div>
                <hr>

                <div id="mosaic-params" class="slider-wrapper">
                    <label for="mosaic_level">モザイクの粗さ:</label>
                    <input type="range" name="mosaic_level" id="mosaic_level_slider" min="2" max="50" value="10" oninput="this.nextElementSibling.value=this.value">
                    <output>10</output>
                </div>

                <div id="popart-params" class="slider-wrapper" style="display:none;">
                    <label for="hue_shift">色相シフト</label>
                    <input type="range" name="hue_shift" id="hue_shift_slider" min="0" max="255" value="100" oninput="this.nextElementSibling.value=this.value">
                    <output>100</output>
                </div>
                <button type="submit" id="submit-btn">画像を処理</button>
            </form>
        </div>

        <!-- 右パネル：処理結果 -->
        <div class="right-panel">
            <h2>処理結果</h2>
            <div id="result">
                <p id="time-display" style="display:none;"></p>
                <img id="processed-image" src="" style="display: none;" alt="処理結果の画像">
            </div>
        </div>
    </div>

    <script>
        //submitイベントリスナーのコード
        document.getElementById('image-form').addEventListener('submit',function(e){e.preventDefault(); //フォームがデフォルトで送信された後画面遷移しないようにしている
            const form = e.target;
            const formData = new FormData(form);
            // 送られてきた全データ(ファイル+粗さor色彩)をformDataに格納
            const imageElement = document.getElementById('processed-image');
            const timeDisplay = document.getElementById('time-display');
            const resultDiv = document.getElementById('result');
            fetch('/process',{  //fetchで非同期でデータを送信
                method:'POST',
                body:formData
            })
            .then(response=> {
                if(response.ok){
                    return response.json(); //blob()→json()に変更.Blobオブジェクトとは画像データを扱うためのオブジェクト
                }
                throw new Error('画像処理に失敗しました');
            })
            .then(data=>{ //dataは{image_data:"...",process_time:0.123}の形式
                //画像の表示
                imageElement.src = data.image_data;  //base64データを直接srcに設定
                imageElement.style.display = 'block';
                //処理時間の表示
                timeDisplay.textContent=`処理時間: ${data.process_time} 秒`;
                timeDisplay.style.display = 'block'; //表示させる
            })
            .catch(error=>{ //エラー処理はjavaと同じ
                console.error('Error:',error);
                alert('エラーが発生');
            });
        });

        //パラメータ表示を切り替える関数
        function toggleParams(){//toggle⇒切替、params⇒パラメータ.パラメータの表示を切り替えるための関数
            const isMosaic = document.getElementById('mode-mosaic').checked;    //.checkedでmode-mosaicが選択されているかどうか(選択されていればtrue)
            const isPopart = document.getElementById('mode-popart').checked;
            document.getElementById('mosaic-params').style.display=isMosaic?'block' : 'none';
            document.getElementById('popart-params').style.display=isPopart?'block' : 'none';
        }
        toggleParams(); //初期表示のために一度呼び出している
    // ファイル名表示用のコード
        document.getElementById('file-input').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '';
            document.getElementById('file-name').textContent = fileName ? `選択: ${fileName}` : '';
        });
        document.getElementById('file-input').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || '';
        document.getElementById('file-name').textContent = fileName ? `選択: ${fileName}` : '';
        });
    </script>

</body>
</html>