<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像処理 Webアプリ</title>
</head>
<body>
    <h1>画像をアップロード</h1>

    <form id="image-form" enctype="multipart/form-data">
        <input type="file" name="file" accept="image/*" required>

        <h3>処理モード選択</h3>
        <input type="radio" name="mode" value="mosaic" id="mode-mosaic" checked onclick="toggleParams()">
        <!-- checkedはページが読み込まれたときにデフォルトでチェックが入っているようにすること.Onclickでボタンが押されたらtoggleParams()関数を呼び出している -->
        <label for="mode-mosaic">モザイクアート</label>
        <input type="radio" name="mode" value="popart" id="mode-popart" onclick="toggleParams()">
        <label for="mode-popart">ポップアート</label>
        <hr>

        <div id="mosaic-params">
            <label for="mosaic_level">モザイクの粗さ:</label>
            <input type="range" name="mosaic_level" id="mosaic_level_slider" min="2" max="50" value="10" oninput="this.nextElementSibling.value=this.value">
            <output>10</output>
        </div>

        <div id="popart-params" style="display:none;">  
            <!-- 最初は非表示.noneが非表示でblockが表示.非表示だとdiv領域が消えて元あった空間に他の内容が詰めて表示される. -->
            <label for="hue_shift">色相シフト</label>
            <input type="range" name="hue_shift" id="hue_shift_slider" min="0" max="255" value="100" oninput="this.nextElementSibling.value=this.value">
            <output>100</output>
        </div>
        <button type="submit" id="submit-btn">画像を処理</button>
    </form>

    <h2>処理結果</h2>
    <div id="result">
        <img id="processed-image" src="" style="max-width: 100%; display: none;"alt="処理結果の画像"> 
        <!-- display noneで画像を非表示状態にしている -->
    </div>

    <script>
        //submitイベントリスナーのコード
        document.getElementById('image-form').addEventListener('submit',function(e){e.preventDefault(); //フォームがデフォルトで送信された後画面遷移しないようにしている
            const form = e.target;
            const formData = new FormData(form);
            // 送られてきた全データ(ファイル+粗さ)をformDataに格納
            const imageElement = document.getElementById('processed-image');
            fetch('/process',{  //fetchで非同期でデータを送信
                method:'POST',
                body:formData
            })
            .then(response=> {
                if(response.ok){
                    return response.blob();
                }
                throw new Error('画像処理に失敗しました');
            })
            .then(imageBlob=>{//Blobオブジェクトとは画像データを扱うためのオブジェクト
                const imageObjectURL = URL.createObjectURL(imageBlob); //下で使うためのURLを生成(もとはBlobオブジェクト)
                imageElement.src = imageObjectURL;  //processed-imageのsrc属性にURLをセット
                imageElement.style.display = 'block';
            })
            .catch(error=>{ //エラー処理はjavaと同じ
                console.error('Error:',error);
                alert('エラーが発生');
            });
        });

        //パラメータ表示を切り替える関数
        function toggleParams(){//toggle⇒切替、params⇒パラメータ.パラメータの表示を切り替えるための関数
            const isMosaic = document.getElementById('mode-mosaic').checked;    //.checkedでmode-mosaicが選択されているかどうか(選択されていればtrue)
            document.getElementById('mosaic-params').style.display=isMosaic?'block' : 'none';
            document.getElementById('popart-params').style.display=isMosaic?'none' : 'block';
        }
    </script>

</body>
</html>